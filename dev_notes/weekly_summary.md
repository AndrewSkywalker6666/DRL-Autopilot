# Weekly Summary

## sep24-oct1

1. 读了三篇文章，见paper reading

2. 实验用机基本搭建完成

   1. 目前放了个NUC8代i5

   2. <u>用TX2做网络推导会不会更快一点？</u>

      > 其实你最后只是应用一下那个网络，所以tx2没太大必要

   3. 但是电子调速器的刷新率貌似很高，推理网络的速度能达到吗?

      > 看你给的指令了

## oct2-oct8

1. 摸索了一下raisim本来想跑一下例子的但迟迟拿不到license

2. 针对future work探索了一下

   1. 关于提到disturbance问题文章里说是可以用RNN解决，但是不太明白这里具体<u>是怎么利用RNN解决干扰</u>

      > 你要尽量做到它能处理较多的不确定性，你在训练的时候可以把很多不确定性放进去
      >
      > 我们没用rnn做无人机的控制

   2. 关于四个电机T的输出的稳定性，找到了sapog这个项目读了一下手册，闭环控制效果貌似会比普通的要好，<u>不知道有没综述性文章对比各种电调的效果？</u>

   3. 还有电机动态的建模，如果用gazebo来仿真训练很容易解决

      > 是的，但是如果你的仿真建模跟实际不一样，那不一定有好处
      >
      > 仿真可以用一个动力学代替
      >
      > 自己用python写就行了

3. 试图设计一个e2e的trajectory tracking controller而不是简单的waypoint tracking

   1. 初步设想对接EGO-planner，因为EGO比较快
   2. 因为放假和处理保研文件的一些事情还处于“新建文件夹”状态
   3. “最后拟合出来的轨迹记为 f(t)，时间序列就是f(t)的定义域的离散化，xyz三个自由度，但是和时间有关”
   4. <u>所以目标就是尽快走直线到达waypoint</u>

4. 明确了DDL：虽然没定死但是建议ASAP

## oct8-oct22

1. 创建了工程文件夹
   1. 开发日志，论文阅读，文献综述
   2. PX4工程
   3. ros1下面的mavros和mavlink
   4. ros2下的msg和px4_com
2. 实现了px4 PWM信号的覆盖逻辑
3. 配置了ros2，把玩了一下rtsp系统
4. 读了近年的一些文章，做了个Taxonomy(paper_reading.md)和LR(literature review.md)

## oct22-nov5

* 考试和课设有点儿多，所以除了学了下SAC，TD3，PPO这些，还有入门了一下gym以外，没有很实质性的进展……下周会抓紧时间

## nov5-nov19

* 依旧是十分充实的两个星期，课设总算是肝完了，毕设的开题报告也整完了，呼呼~
* 现在基于gazebo软件和gym框架以及PX4sitl的，用SAC进行训练的py脚本也基本跑起来了
* 但是有个比较棘手的问题就是每运行一步进行重置的时候传感器数据没办法重置。。。目前卡在这里。。。初步想法是使训练过程独立于px4这些，但这样就得重新写一些gazebo的插件
* 所以现在做把px4提供的那些插件的源码，移植到自己的ros工作空间里的工作

## nov19-dec3

* 完全将gazebo和ros2结合起来了，不用自己写动力学模型并可以处理更复杂的机器人啦（比如过驱动六旋翼），好耶~
  * 官方提供了一个`gazebo_ros_pkg`就是一个大的插件集合，不仅可以用apt安装直接用，还可以参考其中的源码开发自己的插件包
  * 自己的和<u>**ros2通讯**</u>的插件包`custom_gazebo_plugins`里面包含了
    * 关节的速度和角度PID控制
    * 带有物理作用力的，无需调参的关节电机插件
    * 无人机电机-旋翼模型
  * 能通过ros2 topic获取所有模型状态，仿真进行的时间，设置模型状态，给定电机PWM让无人机飞起来等，几乎上是有了full access to gazebo environment
  * 关于使用，有兴趣可以去repo上把玩一下，主要是`sim_gazebo_ros2.sh`里面包含了所有的关键步骤
* 关于无人机电机-旋翼模型，主要是参考了px4_sitl提供的代码，包括了以下的特性
  * 主推力：$F=C_m\omega^2$
  * 旋转反扭力：$\Tau=C_\tau F=C_\tau C_m \omega^2$
  * 空气阻力影响：$ -\omega * \lambda_1 * V_A^{\perp}$，from *The True Role of Accelerometer Feedback in Quadrotor Control*, 2010 ICRA
  * rolling-moment：暂时没有深究是什么
  * 电机的一阶动态模型和加减速滤波器
  * 有个参考issue但还是open，所以先用着先后续有空深入研究下https://github.com/ethz-asl/rotors_simulator/issues/422
  * 这些代码本身是asl的rotors提供的，也许能够这篇文章中看到https://www.researchgate.net/publication/309291237_RotorS_-_A_Modular_Gazebo_MAV_Simulator_Framework，但也先放一放
* DRL的环境配置，包括conda，pytorch，tf，cuda，跟着youtube某个教程学会了怎么自己构建训练环境
* 无人机训练过程设计
  * 训练目标为训练出一个用于追踪轨迹$x(t)=[pos(t), attitude(t)], \Delta t=100ms$的端到端的智能体
  * 状态向量$X=[t, e_{pos}, e_R, v_s, \omega_s]$，分别是运行时间，位置误差，旋转矩阵误差，空间线速度和空间角速度，均为可观测量，目前打算使用gazebo API直接提供的真值，如果还要更精确的话需要模拟EKF2，这个后面再说
  * 期望的状态向量为$X_{dst}=[100, 0, I]$，代表的意思是在运行时为100ms的时候与设定点的位置误差为0，与设定点的旋转误差为0，即旋转矩阵为单位矩阵
    * 剩余的状态不做要求，因为需要前端的规划，不好做出假设
    * 为什么不要求速度而不要求位置呢，嗯，毕竟是训练出来的，要是追踪有误差最终用起来可能会积累的很严重，而且想尽量“端到端”一点
  * 机器人的$a$为归一化的电机转速，从0到1，训练的时候线性映射到$[100,1100]$的实际旋翼角速度，部署到PX4上应该满足这个关系$\omega = PWM - 900$
  * 训练起始无人机
    * 位置设置为$[0,0,3]$，即高度给一个缓冲缓冲区
    * 运行时间设置为0
    * 姿态，线速度，角速度都在范围内均匀分布取样，其中姿态用旋转矩阵表示，需要在haar distribution里取样
    * $e_{pos}$和$e_R$根据运行的$\Delta t$、随机的初始速度角速度和对应的加速度最大值计算一个范围，然后在这里面均匀取样，这样能够保证这个误差不会超出物理极限
  * 奖励函数设置为状态向量前13个分量和$X_{dst}$的余弦相似度
  * 学习算法采用`stable_baseline3`提供的`SAC`
* 目前同时在为四旋翼和过驱动六旋翼搭建环境，todos
  * 继续完善gazebo-gym的环境
  * 写训练主script，跑跑看，调调参
  * 将网络部署到实际机器人上，写一个根据键鼠输入或者遥控器输入的轨迹生成器进行测试
